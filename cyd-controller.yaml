esphome:
  name: cyd-controller
  friendly_name: CYD Controller

esp32:
  board: esp32dev
  framework:
    type: arduino      #esp-idf

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: "8hSXkSNADVxy6HNXUMRL2CbaBi/93KMGoGvTTjhx7lg="

ota:
  - platform: esphome
    password: "59806caa7491c76c1eee21f0b73cd61d"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Cyd-Controller Fallback Hotspot"
    password: "4ZQHWpRZB63r"

captive_portal:
globals:
  - id: show_return_page
    type: bool
    restore_value: no
    initial_value: "false"
  - id: bcklght_timer
    type: int
    restore_value: no
    initial_value: "0"

# Setup a pin to control the backlight and the LED
output:
  - platform: ledc
    pin: GPIO21
    id: backlight_pwm
  - platform: ledc
    id: output_red
    pin: GPIO4
    inverted: true
  - platform: ledc
    id: output_green
    pin: GPIO16
    inverted: true
  - platform: ledc
    id: output_blue
    pin: GPIO17
    inverted: true

light:
  - platform: monochromatic
    output: backlight_pwm
    name: Display Backlight
    id: backlight
    restore_mode: ALWAYS_ON
  - platform: rgb
    name: LED
    id: led
    red: output_red
    green: output_green
    blue: output_blue
    restore_mode: ALWAYS_OFF

# Setup SPI for the display. The ESP32-2432S028R uses separate SPI buses for display and touch
spi:
  - id: tft
    clk_pin: GPIO14
    mosi_pin: GPIO13
    miso_pin: GPIO12
  - id: touch
    clk_pin: GPIO25
    mosi_pin: GPIO32
    miso_pin: GPIO39

touchscreen:
  platform: xpt2046
  spi_id: touch
  cs_pin: GPIO33
  interrupt_pin: GPIO36
  update_interval: 50ms
  threshold: 400
  calibration:
    x_min: 410
    x_max: 3750
    y_min: 280
    y_max: 3710
  transform:
    mirror_x: True
    mirror_y: False
    swap_xy: False   

# Create a font to use, add and remove glyphs as needed. 
# Crea las fuente que quieres utilizar, añade o quita los caracteres que necesites.

font:
  - file: "gfonts://Coming Soon"
    id: fecha
    size: 15
  - file: "gfonts://Coming Soon"
    id: hora
    size: 58
  - file: "gfonts://Handlee"
    id: info
    size: 15
  - file: "gfonts://Handlee"
    id: botones
    size: 11
#icon showed on the screen, are the icon of HA
image:
  - file: mdi:alarm-light
    id: alarmicon
    resize: 40x40
    type: BINARY      
  - file: mdi:home-lock-open
    id: apriportone
    resize: 40x40
    type: BINARY  
  - file: mdi:alarm-light-outline
    id: alarmicon_outline
    resize: 40x40
    type: BINARY      
  - file: mdi:home-thermometer
    id: hometemperature
    resize: 40x40
    type: BINARY
  - file: mdi:weather-partly-cloudy
    id: weather
    resize: 40x40
    type: BINARY
  - file: mdi:flash
    id: flash
    resize: 40x40
    type: BINARY
  - file: mdi:heart-pulse
    id: health
    resize: 40x40
    type: BINARY
  - file: mdi:page-previous
    id: back
    resize: 40x40
    type: BINARY
  - file: mdi:lightbulb-spot
    id: lightbulb_spot
    resize: 40x40
    type: BINARY
  - file: mdi:lightbulb
    id: lightbulb
    resize: 40x40
    type: BINARY
  - file: mdi:led-strip-variant
    id: led_strip_variant
    resize: 40x40
    type: BINARY
  - file: mdi:fan
    id: fan
    resize: 40x40
    type: BINARY
  - file: mdi:desk
    id: desk
    resize: 40x40
    type: BINARY
  - file: mdi:television
    id: television
    resize: 40x40
    type: BINARY
  - file: mdi:dishwasher
    id: dishwasher
    resize: 40x40
    type: BINARY
  - file: mdi:washing-machine
    id: washingmachine
    resize: 40x40
    type: BINARY    
  - file: mdi:page-next
    id: next
    resize: 40x40
    type: BINARY
  - file: mdi:floor-lamp
    id: floorlamp
    resize: 40x40
    type: BINARY    

# This will fetch time from Home Assistant
time:
  - platform: homeassistant
    id: esptime

# Import sensors from HA you want to use and show.
# MrMr rivedere nomi sensori
sensor:
  - platform: homeassistant
    id: temperatura
    entity_id: sensor.temperatura_media_casa
    internal: true
  - platform: homeassistant
    id: umidita
    entity_id: sensor.umidita_media_casa
    internal: true
  - platform: homeassistant
    id: potenza
    entity_id: sensor.monitor_potenza_consumata_power_a
    internal: true
#Sensor platform:homeassistant to import switch and light
text_sensor:
  - platform: homeassistant
    id: LaMaFiMaAllarme
    entity_id: alarm_control_panel.allarme
    internal: true
  - platform: homeassistant
    id: Portone_Finestre
    entity_id: binary_sensor.sensori_porte_finestra
    internal: true
  - platform: homeassistant
    id: faretti_corridoio
    entity_id: light.faretti_corridoio
    internal: true
  - platform: homeassistant
    id: luce_camera_filippo
    entity_id: light.luce_camera_filippo
    internal: true
  - platform: homeassistant
    id: luce_camera_matteo
    entity_id: light.luce_camera_matteo
    internal: true
  - platform: homeassistant
    id: sp530e_strip
    entity_id: light.sp530e_strip
    internal: true
  - platform: homeassistant
    id: aspiratore
    entity_id: fan.aspiratore_bagno
    internal: true
  - platform: homeassistant
    id: televisore
    entity_id: switch.televisore
    internal: true
  - platform: homeassistant
    id: scrivania
    entity_id: switch.presascrivania
    internal: true
  - platform: homeassistant
    id: lavastoviglie
    entity_id: switch.lavastoviglie
    internal: true
  - platform: homeassistant
    id: lavatrice
    entity_id: switch.lavatrice
    internal: true    
  - platform: homeassistant
    id: piantana
    entity_id: light.piantana_soggiorno
    internal: true              
# Assigns a function to each button, by calling the corresponding service in HA.
# Asigna una función a cada botón, llamando al servicio correspondiente en HA.

binary_sensor:
  - platform: touchscreen
    name: Button 00 #Bottone fake per andare nella prima schermata di bottoni copre data ora
    page_id: idlePage
    x_min: 15
    x_max: 210
    y_min: 5
    y_max: 130
    on_press:
      then:
        - lambda: 'auto call = id(backlight).turn_on(); call.set_brightness(1.0); call.perform();delay(500);'
        - display.page.show: firstPage
  - platform: touchscreen
    name: Button 01 #Bottone attiva allarme
    page_id: idlePage
    x_min: 10
    x_max: 110
    y_min: 130
    y_max: 195
    on_press:
      then: 
        - if:
            condition: #allarme attivo
              lambda: 'return id(LaMaFiMaAllarme).state == "armed_home";'
            then: #disarma allarme
              - globals.set:
                  id: bcklght_timer
                  value: "0"
              - light.turn_on:
                  id: backlight
                  brightness: 100%
              - homeassistant.service:
                  service: alarm_control_panel.alarm_disarm
                  data:
                    entity_id: alarm_control_panel.allarme
                    code: "1234" #codice per disarmare l'allarme
            else: #arma allarme
              - light.turn_on:
                  id: backlight
                  brightness: 100%
              - homeassistant.service:
                  service: alarm_control_panel.alarm_arm_home
                  data:
                    entity_id: alarm_control_panel.allarme
#                    code: "1234" #codice non richiesto per armare l'allarme
  - platform: touchscreen
    name: Button 02
    page_id: idlePage
    x_min: 120
    x_max: 220
    y_min: 130
    y_max: 195
    on_press:
      then:
        - homeassistant.action:
            action: script.script_apri_portone
  - platform: touchscreen
    name: Button 11
    page_id: firstPage
    x_min: 15
    x_max: 115
    y_min: 5
    y_max: 70
    on_press:
      then:
        - homeassistant.service:
            service: light.toggle
            data:
              entity_id: light.faretti_corridoio
  - platform: touchscreen
    name: Button 21
    page_id: firstPage
    x_min: 125
    x_max: 225
    y_min: 5
    y_max: 70
    on_press:
      then:
        - homeassistant.service:
            service: light.toggle
            data:
              entity_id: light.piantana_soggiorno
  - platform: touchscreen
    name: Button 31
    page_id: firstPage
    x_min: 15
    x_max: 115
    y_min: 80
    y_max: 145
    on_press:
      then:
        - homeassistant.service:
            service: light.toggle
            data:
              entity_id: light.sp530e_strip
              brightness: '255'
        - homeassistant.action:                    
            action: select.select_option
            data:
              entity_id: select.sp530e_light_mode
              option: Static White
  - platform: touchscreen
    name: Button 41
    page_id: firstPage
    x_min: 125
    x_max: 225
    y_min: 80
    y_max: 145
    on_press:
      then:
        - homeassistant.service:
            service: fan.toggle
            data:
              entity_id: fan.aspiratore_bagno
  - platform: touchscreen
    name: Button 51
    page_id: firstPage
    x_min: 15
    x_max: 115
    y_min: 155
    y_max: 220
    on_press:
      then:
        - homeassistant.service:
            service: switch.toggle
            data:
              entity_id: switch.presascrivania
  - platform: touchscreen
    name: Button 61
    page_id: firstPage
    x_min: 125
    x_max: 225
    y_min: 155
    y_max: 220
    on_press:
      then:
        - homeassistant.service:
            service: switch.toggle
            data:
              entity_id: switch.televisore
  - platform: touchscreen
    name: Button 71
    page_id: firstPage
    x_min: 15
    x_max: 115
    y_min: 230
    y_max: 295
    on_press:
      then:
        display.page.show: secondPage
  - platform: touchscreen
    name: Button 81
    page_id: firstPage
    x_min: 125
    x_max: 225
    y_min: 230
    y_max: 295
    on_press:
      then:
        - display.page.show: idlePage
        - globals.set:
            id: bcklght_timer
            value: "0"
  - platform: touchscreen
    name: Button 12
    page_id: secondPage
    x_min: 15
    x_max: 115
    y_min: 5
    y_max: 70
    on_press:
      then:
        - homeassistant.service:
            service: switch.toggle
            data:
              entity_id: switch.lavastoviglie
  - platform: touchscreen
    name: Button 22
    page_id: secondPage
    x_min: 125
    x_max: 225
    y_min: 5
    y_max: 70
    on_press:
      then:
        - homeassistant.service:
            service: switch.toggle
            data:
              entity_id: switch.lavatrice 
  - platform: touchscreen
    name: Button 32
    page_id: secondPage
    x_min: 15
    x_max: 115
    y_min: 80
    y_max: 145
    on_press:
      then:
        - homeassistant.service:
            service: switch.toggle
            data:
              entity_id: switch.luce_camera_matteo  
  - platform: touchscreen
    name: Button 42
    page_id: secondPage
    x_min: 125
    x_max: 225
    y_min: 80
    y_max: 145
    on_press:
      then:
        - homeassistant.service:
            service: light.toggle
            data:
              entity_id: light.luce_camera_filippo
  - platform: touchscreen
    name: Button 82
    page_id: secondPage
    x_min: 125
    x_max: 225
    y_min: 230
    y_max: 295
    on_press:
      then:
        - display.page.show: idlePage
        - globals.set:
            id: bcklght_timer
            value: "0"

# Setup the ili9xxx platform
# Display is used as 240x320 by default so we rotate it to 90°

display:
  - platform: ili9xxx
    id: esp_display
    model: ILI9341
    spi_id: tft
    cs_pin: GPIO15
    dc_pin: GPIO2
    color_palette: 8BIT
    rotation: 0
    invert_colors: False
    pages:
      - id: idlePage
        lambda: |-
          auto rosso = Color(255, 0, 0);
          auto grigio = Color(128,128,128);
          int button_width = 100;
          int button_height = 65;
          static int current_text_index = 0;
          static float text_timer = 0;
          const float text_interval = 2.0;  // Intervalo para cambiar el texto en segundos
          const int bcklght_interval = 30;  // Intervallo spengimento bcklght
          if(id(esptime).now().is_valid())
          {
            it.strftime(120, 20, id(fecha), TextAlign::CENTER, "%d/%m/%Y", id(esptime).now());
            it.strftime(120, 60, id(hora), TextAlign::CENTER, "%H:%M", id(esptime).now());
            it.rectangle(10, 130, button_width, button_height, grigio);
            it.rectangle(120, 130, button_width, button_height, grigio);
            it.image(150, 140, id(apriportone), grigio);
            if (id(LaMaFiMaAllarme).state == "armed_home")
              it.image(40, 140, id(alarmicon), rosso);
            else
              it.image(40, 140, id(alarmicon), grigio);
            text_timer += 1.0;
            id(bcklght_timer) ++;
            if (text_timer >= text_interval)
            {
              text_timer = 0;
              current_text_index = (current_text_index + 1) % 2;  // Alternar entre cuatro textos
            }            
            if (id(bcklght_timer) >= bcklght_interval)
            {
              id(bcklght_timer) = 0;
              auto call = id(backlight).turn_on();
              call.set_brightness(0.3);
              //perform action...
              call.perform();
            }
            if (current_text_index == 0)
            {
              it.image(15, 210, id(hometemperature), rosso);
              it.print(70, 210, id(info), "Temperatura");
              it.printf(175, 210, id(info), "%.1f C", id(temperatura).state);
              it.print(70, 230, id(info), "Umidita'");
              it.printf(175, 230, id(info), "%.1f %%", id(umidita).state);
             
            } else if (current_text_index == 1) 
            {
              it.image(15, 210, id(flash), rosso);
              it.print(70, 210, id(info), "Potenza");
              it.printf(175, 210, id(info), "%.1f W", id(potenza).state); 
            }            
            if ( (id(Portone_Finestre).state == "on") && (id(LaMaFiMaAllarme).state == "armed_home" || id(LaMaFiMaAllarme).state == "armed_away"))
            {
              static bool bAlarmColorToggle = true;
              id(bcklght_timer) = 0;
              auto call = id(backlight).turn_on();
              call.set_brightness(1.0);
              //perform action...
              call.perform();

              if (bAlarmColorToggle)
              {
                it.image(100, 140, id(alarmicon), rosso);
                auto call = id(led).turn_on();
                call.set_rgb(1.0, 0.0,0.0);
                call.perform();
                bAlarmColorToggle = false;
              }
              else
              {
                it.image(100, 140, id(alarmicon_outline), grigio);
                auto call = id(led).turn_off();
                call.perform();
                bAlarmColorToggle = true;
              }
            }
            else
            {
              auto call = id(led).turn_off();
              call.perform();
            }
          }
      - id: firstPage
        lambda: |-
            auto rosso = Color(255, 0, 0);
            auto grigio = Color(128,128,128);
            auto nero = Color(0, 0, 0);
            auto call = id(backlight).turn_on();
            call.set_brightness(1.0);
            //perform action...
            call.perform();
            id(bcklght_timer) = 0;
            if(id(Portone_Finestre).state == "on" && (id(LaMaFiMaAllarme).state == "armed_home" || id(LaMaFiMaAllarme).state == "armed_away") )
            {
              static bool bAlarmColorToggle = true;
              if (bAlarmColorToggle)
              {
                it.image(100, 140, id(alarmicon), rosso);
                auto call = id(led).turn_on();
                call.set_rgb(1.0, 0.0,0.0);
                call.perform();
                bAlarmColorToggle = false;
              }
              else
              {
                it.image(100, 140, id(alarmicon_outline), grigio);
                auto call = id(led).turn_off();
                call.perform();
                bAlarmColorToggle = true;
              }
              return;  
            }
            if (1) {
              int button_width = 100;
              int button_height = 65;
              int x_start = 15;
              int y_start = 15;
              int x_padding = 10;
              int y_padding = 10;

              // Define los textos para los botones
              const char* button_texts[] = {
                "Corridoio",
                "Piantana soggiorno",
                "Led Tv",
                "Asp.Bagno",
                "Scrivania",
                "Televisore",
                "Avanti",
                "Indietro"
              };

              for (int row = 0; row < 4; row++) {
                for (int col = 0; col < 2; col++) {
                  int button_index = row * 2 + col;
                  int x = x_start + col * (button_width + x_padding);
                  int y = y_start + row * (button_height + y_padding);
                  it.rectangle(x, y, button_width, button_height, grigio);
                  int text_width = strlen(button_texts[button_index]) * 5.5; 
                  int text_height = 16; 
                  it.print(x + (button_width - text_width) / 2, y + (button_height - text_height) / 2 + 20, id(botones), button_texts[button_index]);
                }
              }
              if (id(faretti_corridoio).state == "on") {
                it.image(45, 20, id(lightbulb_spot), rosso);
              } else {
                it.image(45, 20, id(lightbulb_spot), grigio);
              }
              if (id(piantana).state == "off") {
                it.image(155, 20, id(floorlamp), grigio);
              } else {
                it.image(155, 20, id(floorlamp), rosso);
              }
              if (id(sp530e_strip).state == "off") {
                it.image(45, 95, id(led_strip_variant), grigio);
              } else {
                it.image(45, 95, id(led_strip_variant), rosso);
              }
              if (id(aspiratore).state == "on") {
                it.image(155, 95, id(fan), rosso);
              } else {
                it.image(155, 95, id(fan), grigio);
              }
              if (id(scrivania).state == "on") {
                it.image(45, 170, id(desk), rosso);
              } else {
                it.image(45, 170, id(desk), grigio);
              }
              if (id(televisore).state == "on") {
                it.image(155, 170, id(television), rosso);
              } else {
                it.image(155, 170, id(television), grigio);
              }
              /*if (id(lavastoviglie).state == "on") {
                it.image(45, 245, id(dishwasher), rosso);
              } else {
                it.image(45, 245, id(dishwasher), grigio);
              }*/
              it.image(45, 245, id(next), grigio);
              it.image(155, 245, id(back), grigio);

            } 
      - id: secondPage
        lambda: |-
            auto rosso = Color(255, 0, 0);
            auto grigio = Color(128,128,128);
            auto nero = Color(0, 0, 0);
            auto call = id(backlight).turn_on();
            call.set_brightness(1.0);
            //perform action...
            call.perform();
            id(bcklght_timer) = 0;
            if(id(Portone_Finestre).state == "on" && (id(LaMaFiMaAllarme).state == "armed_home" || id(LaMaFiMaAllarme).state == "armed_away") )
            {
              static bool bAlarmColorToggle = true;
              if (bAlarmColorToggle)
              {
                it.image(100, 140, id(alarmicon), rosso);
                auto call = id(led).turn_on();
                call.set_rgb(1.0, 0.0,0.0);
                call.perform();
                bAlarmColorToggle = false;
              }
              else
              {
                it.image(100, 140, id(alarmicon_outline), grigio);
                auto call = id(led).turn_off();
                call.perform();
                bAlarmColorToggle = true;
              }
              return;  
            }
            if (1) {
              int button_width = 100;
              int button_height = 65;
              int x_start = 15;
              int y_start = 15;
              int x_padding = 10;
              int y_padding = 10;

              // Define los textos para los botones
              const char* button_texts[] = {
                "Lavastoviglie",
                "Lavatrice",
                "Luce Matteo",
                "Luce Filippo",
                "",
                "",
                "",
                "Indietro"
              };

              for (int row = 0; row < 4; row++) {
                for (int col = 0; col < 2; col++) {
                  int button_index = row * 2 + col;
                  int x = x_start + col * (button_width + x_padding);
                  int y = y_start + row * (button_height + y_padding);
                  it.rectangle(x, y, button_width, button_height, grigio);
                  int text_width = strlen(button_texts[button_index]) * 5.5; 
                  int text_height = 16; 
                  it.print(x + (button_width - text_width) / 2, y + (button_height - text_height) / 2 + 20, id(botones), button_texts[button_index]);
                }
              }
              if (id(lavastoviglie).state == "on") {
                it.image(45, 20, id(dishwasher), rosso);
              } else {
                it.image(45, 20, id(dishwasher), grigio);
              }
              if (id(lavatrice).state == "off") {
                it.image(155, 20, id(washingmachine), grigio);
              } else {
                it.image(155, 20, id(washingmachine), rosso);
              }
              if (id(luce_camera_matteo).state == "off") {
                it.image(45, 95, id(lightbulb), grigio);
              } else {
                it.image(45, 95, id(lightbulb), rosso);
              }
              if (id(luce_camera_filippo).state == "on") {
                it.image(155, 95, id(lightbulb), rosso);
              } else {
                it.image(155, 95, id(lightbulb), grigio);
              }              
              it.image(155, 245, id(back), grigio);
            }
# For example cycle through pages on a timer
#interval:
#  - interval: 30s
#    then:
#      - display.page.show: idlePage

#interval:
#  - interval: 30s
#    then:
#      - if:
#         condition:
#           not:
#             display.is_displaying_page: idlePage
#         then:
#           - display.page.show: idlePage